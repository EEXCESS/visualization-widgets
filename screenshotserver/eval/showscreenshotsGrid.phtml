<?php

error_reporting(E_ALL & ~E_NOTICE);// Melde alle Fehler auÃŸer E_NOTICE
ini_set('display_errors', 1);

header("Cache-Control: no-cache, no-store, must-revalidate"); 
header("Pragma: no-cache");
header("Expires: 0");

require_once("ScreenshotVis.php");

$ssVis = new ScreenshotVis();
$errors = [];
$imageList = [];
try
{
    $ssVis->init();
    $imageList = $ssVis->getRandomImages('-filter.JPEG');
} catch (EvalException $ex)
{
    $errors = $ssVis->getErrors();
}


?>

<html>

<head>
    <style>
        form{
            width:660px;
        }
        .chart{
            text-align: center;
            vertical-align: middle;
            border: 1px solid black;
            display: inline-block;
            margin:9px 4px;
            height:200px;
            width:200px;
        }
            .chart:hover{
                background-color:#eeeeee;
            }
            .chart.checked{
                background-color:lightgreen !important;
            }
            .chart img{
                max-width:173px;
                max-height:180px;
            }
        #largeImageContainer{
            border: 1px solid black;
            position:absolute;
            right:0;
            top:0;
            padding:3px;
            max-height:300px;
        }
        #largeImageContainer img{
            max-width:400px;
            max-height:400px;
        }

    </style>
    <link rel="stylesheet" href="eval.css">
    <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
    <script>
        $(document).on('ready', function(){
            
            parent.postMessage({action:"setHeight", height: $(document).height() }, "*");

            $('.chart').on('click', function(){
                $(this).toggleClass('checked');
                $(this).find('input').prop('checked', !$(this).find('input').prop('checked'));
            });
            $('input').on('click', function(e){
                $(this).closest('.chart').toggleClass('checked');
                e.stopPropagation();
            });
            $('body .chart img[src*="Main-"]').each(function(){
                $(this).closest('.chart').addClass('Main');
                $(this).on('mouseover', function(){
                    // show large image
                    var $img = $('<img />').attr('src', $(this).attr('src'));
                    $('#largeImageContainer').empty().show().append($img);
                }).on('mouseout', function(){
                    $('#largeImageContainer').hide().find('img').remove();
                });
            });
        });

        // will be called from outside:
        function saveData(){
            console.log('saveData called');
            var selection = {selectedImages: [], userName:"<?php echo $ssVis->getCurrentUserName(); ?>", userId:<?php echo $ssVis->evalData->userId; ?>, session=<?php echo $_GET["sessionId"]; ?>, timestamp: new Date(), refUsers: "<?php echo $_GET["refUsers"]; ?>", questionnnaireDay: "<?php echo $_GET["questionnnaireDay"]; ?>" };
            $('.chartselection:checked').each(function(){
                selection.selectedImages.push({
                    image: $(this).data('imagename'),
                    user: $(this).data('imageuser'),
                });
            });
            
            $.ajax({
                type:'POST',
                url: 'saveUsersSelection.php',
                data: JSON.stringify(selection),
                success: function(){
                }
            });
        }

        function listener(event){
            if (event.data == "saveData")
                saveData();
        }
        if (window.addEventListener){
            addEventListener("message", listener, false)
        } else {
            attachEvent("onmessage", listener)
        }
        
    </script>
</head>


<body class="<?php echo $_GET['css']; ?>">
<div id='largeImageContainer' style='display:none;'></div>

<form>

    <?php foreach ($imageList as $index => $userAndImage) : ?>
    <div class='chart'>
        <img class="screenshotimg" src="<?php echo $userAndImage->imageurl ?>" />
        <br />
        <input type="checkbox" class='chartselection' data-imagename='<?php echo $userAndImage->imagename ?>' data-imageuser='<?php echo $userAndImage->user ?>' />
    </div>
    <?php endforeach; ?>    

</form>


</body>
</html>
