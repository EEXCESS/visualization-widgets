<html>
    <head>
        <title>Search Interface and Resultlist Example</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <form id="test">
            <input id="query" size="20" />
            <input id="submit" type="submit" value="submit" />
        </form>
        <!-- load requirejs -->
        <script src="require.js"></script>
        <script>
            // load dependencies
            require(['jquery', 'c4/APIconnector', 'c4/iframes'], function ($, api, iframes) {
                // set the URL of the federated recommender to the stable server
                api.init({url: 'http://eexcess.joanneum.at/eexcess-privacy-proxy/api/v1/recommend'});
                
                // handle form submit
                $('#test').submit(function (evt) {
                    evt.preventDefault();
                    
                    /*
                     * Construct an EEXCESS profile in the format described at https://github.com/EEXCESS/eexcess/wiki/json-exchange-format#request-format.
                     * At this point, we only fill the absolute minimal set of required attributes, namely "contextKeywords", which basically represent a query.
                     */
                    var profile = {contextKeywords: [{
                                text: $('#query').val(),
                                weight: 1.0
                            }]};
                    
                    /*
                     * Send a message to all iframes embedded in this window, using the function provided by the "iframes"-module from the c4 repository.
                     * The message informs all embedded iframes, that a query has been triggered by some component and also includes the associated profile.
                     * For the full list of events, which may be supported by the widgets see the readme in the root folder.
                     */
                    iframes.sendMsgAll({event: 'eexcess.queryTriggered', data: profile});
                    
                    /*
                     * Send a request to the EEXCESS federated recommender, using the function provided by the "APIconnector"-module from the c4 repository.
                     * A callback function is specified, that takes the request's response data as input. The response consists of an attribute "status", that 
                     * indicates the status of the request (either "success" or "error") and the corresponding data in the "data" attribute.
                     */
                    api.query(profile, function (res) {
                        if (res.status === 'success') {
                            /*
                             * If the request was successful, inform all embedded iframes about the success and provide the corresponding data.
                             * For the full list of events, which may be supported by the widgets see the readme in the root folder.
                             */
                            iframes.sendMsgAll({event: 'eexcess.newResults', data: {profile:profile,results:{results:res.data.result}}});
                        } else {
                            /*
                             * If the request was not succesful, inform all embedded iframes about the error and provide the corresponding data.
                             */
                            iframes.sendMsgAll({event:'eexcess.error',data:res.data});
                        }
                    });
                });
                
                /*
                 * Listen for message from the embedded iframes.
                 */
                window.onmessage = function(msg) {
                    /*
                     * Here, we are only interested in ratings that might have been given in one of the included widgets.
                     * For the full list of possible events, see the readme in the root folder.
                     */
                    if(msg.data.event && msg.data.event === 'eexcess.rating') {
                        console.log('The resource: ' + msg.data.data.uri + ' has been rated with a score of ' + msg.data.data.score);
                    }
                };
            });
        </script>
        
        <!-- Include the desired widgets as iframes. In this case, the SearchResultList-widget is included. -->
        <iframe src="../../SearchResultList/index.html" style="position:absolute;width:400px;height:500px;"></iframe>
    </body>
</html>
